<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>title</title>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
    <script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/chartist-plugin-axistitle@0.0.4/dist/chartist-plugin-axistitle.min.js"></script>
    <style>
      .container {
        display: grid;
        grid-template-rows: repeat(2, 1fr);
        grid-template-columns: repeat(2, 1fr);
        width: 100vw;
        height: 100vh;
      }

      .graphWrapper {
        text-align: center;
        padding-bottom: 25px;
      }
      
      .ct-series-b .ct-slice-pie {
        fill: #1ce136;
      }
      
      .graphWrapper > div {
        height: 75%;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="graphWrapper">
        <span>Requests Per Minute - Last 5 minutes</span>
        <div class="requestsPerMinuteChart"></div>
      </div>
      <div class="graphWrapper">
        <span>Clusters (Size vs Duration)</span>
        <div class="clustersChart"></div>
      </div>
      <div class="graphWrapper">
        <span>Average Request Time (in ms - Last 5 minutes)</span>
        <div class="avgChart"></div>
      </div>
      <div class="graphWrapper">
        <span>Request Success Rate</span>
        <div class="requestSuccessRate"></div>
      </div>
    </div>
    <script>
      var labels = [
        new Date().getHours() + ":" + (new Date().getMinutes() - 4),
        new Date().getHours() + ":" + (new Date().getMinutes() - 3),
        new Date().getHours() + ":" + (new Date().getMinutes() - 2),
        new Date().getHours() + ":" + (new Date().getMinutes() - 1),
        new Date().getHours() + ":" + new Date().getMinutes()
      ];


      $.get("/dashboard/clusters", function(data) {
        const seriesData = [];
        for (var i = 0; i < data.length; i++) {
          var series = [];
          var points = data[i].points;
          for (var j = 0; j < points.length; j++) {
            series.push({x: points[j][1], y: points[j][0]});
          }
          seriesData.push(series);
        }

        var chart = new Chartist.Line('.clustersChart', {
          labels: [],
          series: seriesData
        },
        {
          chartPadding: {
            left: 20,
            bottom: 10
          },
          showLine: false,
          axisX: {
            high: 500,
            type: Chartist.AutoScaleAxis,
            onlyInteger: true
          },
          plugins: [
            Chartist.plugins.ctAxisTitle({
              axisX: {
                axisTitle: "Response Time (millis)",
                axisClass: "ct-axis-title",
                offset: {
                  x: 0,
                  y: 35
                },
                textAnchor: "middle"
              },
              axisY: {
                axisTitle: "Request Size",
                axisClass: "ct-axis-title",
                offset: {
                  x: 0,
                  y: -1
                },
                flipTitle: false
              }
            })
          ]
        });
      });

      $.get("/dashboard/rpm", function(data) {
        var dataForTable = [];

        for (i = 0; i < data.length; i++) {
          dataForTable.push({ x: new Date(data[i].date_trunc), y: data[i].count })
        }

        dataForTable.sort(function(a, b) {
          return new Date(b) - new Date(a);
        });

        var chart = new Chartist.Line('.requestsPerMinuteChart', {
          labels: labels,
          series: [{
            name: 'series-1',
            data: dataForTable
          }]
        });
      });

      $.get("/dashboard/latency", function(data) {
        var dataForTable = [];

        for (i = 0; i < data.length; i++) {
          dataForTable.push({ x: new Date(data[i].date_trunc), y: data[i].latency })
        }

        dataForTable.sort(function(a, b) {
          return new Date(b) - new Date(a);
        });

        var chart = new Chartist.Line('.avgChart', {
          labels: labels,
          series: [{
            name: 'series-1',
            data: dataForTable
          }]
        });
      });

      $.get("/dashboard/errors", function(data) {
        var dataForTable = {
          series: [parseInt(data[0].errorcount), parseInt(data[0].totalcount)]
        };
        var chart = new Chartist.Pie('.requestSuccessRate', dataForTable, {
          labelInterpolationFnc: function(value) {
            return Math.round(value / (parseInt(data[0].errorcount) + parseInt(data[0].totalcount)) * 100) + '%';
          }
        });
      });
    </script>
  </body>
</html>
